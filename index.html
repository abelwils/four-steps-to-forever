<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Three Steps to Forever üíç</title>
  <style>
    body {
      margin: 0;
      background: radial-gradient(circle, #12122a, #070712);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: white;
    }
    canvas {
      background: linear-gradient(#2a2a55, #1a1a40);
      border-radius: 18px;
      box-shadow: 0 0 50px rgba(0,0,0,0.8);
    }
    .hint {
      position: absolute;
      top: 16px;
      font-size: 15px;
      letter-spacing: 0.5px;
      z-index: 10;
      text-shadow: 1px 1px 2px black;
    }
    .msg {
      position: absolute;
      top: 42px;
      color: #ffb3c1;
      font-size: 22px;
      font-weight: bold;
      z-index: 10;
      text-align: center;
      width: 100%;
    }
    #proposal-ui {
      position: absolute;
      background: rgba(15, 15, 35, 0.95);
      padding: 30px;
      border-radius: 20px;
      border: 3px solid #ff6b81;
      text-align: center;
      display: none;
      flex-direction: column;
      align-items: center;
      max-width: 450px;
      z-index: 100;
      box-shadow: 0 0 30px rgba(255, 107, 129, 0.6);
    }
    #proposal-text {
      font-size: 17px;
      line-height: 1.6;
      margin-bottom: 25px;
      color: #fff;
    }
    .btn-group {
      display: flex;
      gap: 20px;
    }
    .p-btn {
      background: #ff6b81;
      border: none;
      color: white;
      padding: 12px 35px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .p-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px #ff6b81;
      background: #ff4757;
    }
    #joystick {
      position: absolute;
      bottom: 30px;
      left: 30px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: none;
      touch-action: none;
      border: 1px solid rgba(255,255,255,0.2);
    }
    #stick {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ff6b81;
      left: 30px;
      top: 30px;
    }
  </style>
</head>
<body>

<div class="hint" id="hint">Level 1: Walk to the right ‚ù§Ô∏è</div>
<div class="msg" id="msg"></div>

<div id="proposal-ui">
    <div id="proposal-text"></div>
    <div class="btn-group">
        <button class="p-btn" onclick="sayYes()">Yes</button>
        <button class="p-btn" onclick="sayYes()">YESS</button>
    </div>
</div>

<canvas id="game" width="700" height="520"></canvas>
<div id="joystick"><div id="stick"></div></div>

<audio id="bgm" src="music.mp3" loop></audio>
<audio id="weddingBgm" src="wedding.mp3" loop></audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const hintEl = document.getElementById("hint");
const msgEl = document.getElementById("msg");
const proposalUi = document.getElementById("proposal-ui");
const proposalText = document.getElementById("proposal-text");
const bgm = document.getElementById("bgm");
const weddingBgm = document.getElementById("weddingBgm");

// Assets
const girl = { down: [new Image(), new Image()], up: new Image(), left: [new Image(), new Image()], right: [new Image(), new Image()] };
girl.down[0].src = "pixelforwardsmile1.png";
girl.down[1].src = "pixelforwardsmile2.png";
girl.up.src = "pixelbacksmile.png";
girl.left[0].src = "pixelfacingsideleft.png";
girl.left[1].src = "pixelsidewaysleft.png";
girl.right[0].src = "pixelfacingsideright.png";
girl.right[1].src = "pixelsidewaysright.png";

const maleCharImg = new Image();
maleCharImg.src = "male_character.png";
const ringImg = new Image();
ringImg.src = "ring.png";

// Game State
const SIZE = 28;
// EVEN SLOWER: Set to 1.5 for a very deliberate, steady walk
const player = { x: 40, y: 260, dx: 0, dy: 0, speed: 1.5, dir: "down", frame: 0, tick: 0 };
let level = 1;
let resetting = false;
let showRing = false;
let accepted = false;
let walkTogether = false;
let bgmStarted = false;
let hearts = [];
let fireworks = [];

// Level Elements
const walls2 = [{x:180,y:0,w:20,h:420},{x:300,y:100,w:20,h:420},{x:420,y:0,w:20,h:320},{x:540,y:200,w:20,h:320},{x:240,y:380,w:200,h:20}];
const door2 = {x:660, y:200, w:20, h:120};
const walls3 = [{x:160,y:0,w:20,h:520},{x:360,y:0,w:20,h:300},{x:360,y:360,w:20,h:160}];
const box = {x:220, y:260, w:30, h:30};
const sw = {x:440, y:260, w:40, h:40};
const door3 = {x:660, y:200, w:20, h:120};
let d3o = false;
const walls4 = [{x:0, y:0, w:700, h:180},{x:0, y:340, w:700, h:180},{x:220, y:180, w:20, h:60},{x:220, y:300, w:20, h:40},{x:460, y:180, w:20, h:60},{x:460, y:300, w:20, h:40}];
const redZone4 = {x:0, y:180, w:220, h:160};
const door4 = {x:680, y:210, w:20, h:100};

const maleCharacter = { x: 350, y: 240, w: 32, h: 48 };

// Input Logic
document.addEventListener("keydown", e => {
  if (accepted) return;
  if (["ArrowUp", "w"].includes(e.key)) { player.dy = -1; player.dir = "up"; }
  if (["ArrowDown", "s"].includes(e.key)) { player.dy = 1; player.dir = "down"; }
  if (["ArrowLeft", "a"].includes(e.key)) { player.dx = -1; player.dir = "left"; }
  if (["ArrowRight", "d"].includes(e.key)) { player.dx = 1; player.dir = "right"; }
  
  if (!bgmStarted && level < 5) {
    bgm.volume = 0.4;
    bgm.play().catch(() => {});
    bgmStarted = true;
  }
});

document.addEventListener("keyup", e => {
  if (["ArrowUp","w","ArrowDown","s"].includes(e.key)) player.dy = 0;
  if (["ArrowLeft","a","ArrowRight","d"].includes(e.key)) player.dx = 0;
});

function sayYes() {
    proposalUi.style.display = 'none';
    accepted = true;
    msgEl.textContent = "YES! Forever and Always ‚ù§Ô∏è";
    
    // Falling Hearts Rain
    for(let i=0; i<80; i++) {
        hearts.push({
            x: Math.random() * canvas.width,
            y: Math.random() * -canvas.height,
            vy: Math.random() * 1.5 + 0.5,
            size: Math.random() * 15 + 10,
            symbol: Math.random() > 0.5 ? "‚ù§Ô∏è" : "üíñ"
        });
    }

    setTimeout(() => {
        walkTogether = true;
        setInterval(() => {
            if(walkTogether) createFirework(Math.random()*canvas.width, Math.random()*canvas.height/2);
        }, 900);
    }, 1000);
}

function createFirework(x, y) {
    const colors = ['#ff6b81', '#ffffff', '#ffd700', '#ff9ff3', '#00d2ff'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    for (let i = 0; i < 25; i++) {
        fireworks.push({
            x: x, y: y,
            vx: (Math.random() - 0.5) * 5,
            vy: (Math.random() - 0.5) * 5,
            life: 100,
            color: color
        });
    }
}

function update() {
  if (resetting) return;

  // VERY SLOW WALK OFF: Set to 0.5
  if (walkTogether) {
      player.x += 0.5;
      maleCharacter.x += 0.5;
      player.dir = "right";
      player.tick++;
      // Slower animation frames to match slow movement
      if (player.tick % 35 === 0) player.frame = (player.frame + 1) % 2;
  }

  const mx = (player.dx) * player.speed;
  const my = (player.dy) * player.speed;
  let nx = player.x + mx;
  let ny = player.y + my;

  // Level Logic
  if (level === 2) {
    for (const w of walls2) if (hit({x:nx,y:ny}, w)) { 
      resetting = true; msgEl.textContent = "Watch out! üíû";
      setTimeout(() => { msgEl.textContent = ""; player.x = 40; player.y = 260; resetting = false; }, 800);
      return; 
    }
  }

  if (level === 3) {
    for (const w of walls3) if (hit({x:nx,y:ny}, w)) return;
    if (hit({x:nx,y:ny}, box)) {
      const bx = box.x + mx, by = box.y + my;
      let blocked = false;
      for (const w of walls3) if (hit({x:bx,y:by}, w)) blocked = true;
      if (!blocked) { box.x = bx; box.y = by; } else return;
    }
  }

  if (level === 4) {
    for (const w of walls4) if (hit({x:nx,y:ny}, w)) return;
    if (hit({x:nx,y:ny}, redZone4)) {
      resetting = true; msgEl.textContent = "Try again! :)";
      setTimeout(() => { msgEl.textContent = ""; player.x = 330; player.y = 260; resetting = false; }, 800);
      return;
    }
    if (hit({x:nx,y:ny}, door4)) {
      level = 5; 
      hintEl.textContent = "Something is waiting... ‚ù§Ô∏è"; 
      player.x = 100; player.y = 260;
    }
  }

  if (level === 5 && !accepted) {
      const dist = Math.hypot(player.x - maleCharacter.x, player.y - maleCharacter.y);
      if (dist < 80 && !showRing) {
          showRing = true;
          bgm.pause();
          bgm.currentTime = 0;
          weddingBgm.volume = 0.6;
          weddingBgm.play().catch(() => {});
          
          proposalUi.style.display = 'flex';
          proposalText.textContent = "Sejak kamu hadir dalam hidupku, semuanya terasa lebih bermakna. Kamu adalah kebahagiaanku. Maukah kamu memilihku seperti aku selalu memilihmu?";
      }
  }

  if (!accepted) {
    player.x = nx; player.y = ny;
    player.x = Math.max(0, Math.min(canvas.width - SIZE, player.x));
    player.y = Math.max(0, Math.min(canvas.height - SIZE, player.y));
    if (mx !== 0 || my !== 0) {
        player.tick++; 
        // Slower animation frames
        if (player.tick % 25 === 0) player.frame = (player.frame + 1) % 2;
    }
  }

  // Transitions
  if (level === 1 && player.x > canvas.width - 40) { level = 2; hintEl.textContent = "Level 2: Navigation ‚ù§Ô∏è"; player.x = 40; player.y = 260; }
  if (level === 2 && hit(player, door2)) { level = 3; hintEl.textContent = "Level 3: Teamwork üíû"; player.x = 190; player.y = 260; }
  if (level === 3 && hit(box, sw)) {
      d3o = true;
      if (hit(player, door3)) { level = 4; hintEl.textContent = "Level 4: Intuition üí≠‚ù§Ô∏è"; player.x = 330; player.y = 260; }
  }

  // Particles
  hearts.forEach(h => { h.y += h.vy; if (h.y > canvas.height) h.y = -20; });
  fireworks.forEach((f, i) => { f.x += f.vx; f.y += f.vy; f.life--; if (f.life <= 0) fireworks.splice(i, 1); });
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (level === 2) {
    ctx.fillStyle = "rgba(255,255,255,0.1)"; walls2.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));
    ctx.fillStyle = "#ff6b81"; ctx.fillRect(door2.x, door2.y, door2.w, door2.h);
  }
  if (level === 3) {
    ctx.fillStyle = "rgba(255,255,255,0.1)"; walls3.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));
    ctx.fillStyle = "#c49a6c"; ctx.fillRect(box.x, box.y, box.w, box.h);
    ctx.fillStyle = d3o ? "#88ffcc" : "#555"; ctx.fillRect(sw.x, sw.y, sw.w, sw.h);
    ctx.fillStyle = "#ff6b81"; ctx.fillRect(door3.x, door3.y, door3.w, door3.h);
  }
  if (level === 4) {
    ctx.fillStyle = "rgba(200, 30, 60, 0.2)"; ctx.fillRect(redZone4.x, redZone4.y, redZone4.w, redZone4.h);
    ctx.fillStyle = "rgba(255,255,255,0.1)"; walls4.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));
    ctx.fillStyle = "#ff6b81"; ctx.fillRect(door4.x, door4.y, door4.w, door4.h);
  }

  if (level === 5) {
      ctx.drawImage(maleCharImg, maleCharacter.x, maleCharacter.y, maleCharacter.w, maleCharacter.h);
      
      if (showRing && !walkTogether) {
          let pulse = Math.sin(Date.now() / 200) * 15 + 15;
          ctx.save();
          ctx.shadowBlur = pulse;
          ctx.shadowColor = "#ffffff";
          ctx.drawImage(ringImg, maleCharacter.x - 20, maleCharacter.y + 10, 22, 22);
          ctx.restore();
      }
  }

  hearts.forEach(h => { ctx.font = `${h.size}px Arial`; ctx.fillText(h.symbol, h.x, h.y); });

  fireworks.forEach(f => {
      ctx.fillStyle = f.color;
      ctx.globalAlpha = f.life / 100;
      ctx.fillRect(f.x, f.y, 4, 4);
  });
  ctx.globalAlpha = 1;

  let img = girl.down[0];
  if (player.dir === "down") img = girl.down[player.frame];
  if (player.dir === "up") img = girl.up;
  if (player.dir === "left") img = girl.left[player.frame];
  if (player.dir === "right") img = girl.right[player.frame];
  
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(img, player.x, player.y, SIZE, SIZE);
}

function hit(a, b) {
  return (a.x < b.x + b.w && a.x + SIZE > b.x && a.y < b.y + b.h && a.y + SIZE > b.y);
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>